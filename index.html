<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cultural AR Experience</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.4/dist/mindar-image-three.prod.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #1a2a6c, #b21f1f);
      color: white;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }
    
    #loading {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 100;
      transition: opacity 0.5s;
    }
    
    #loading h1 {
      font-size: 2.5rem;
      margin-bottom: 20px;
      text-align: center;
      color: #ffcc00;
      text-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
    }
    
    #loading p {
      font-size: 1.2rem;
      margin-bottom: 30px;
      text-align: center;
      max-width: 80%;
    }
    
    .loader {
      width: 60px;
      height: 60px;
      border: 5px solid rgba(255, 255, 255, 0.2);
      border-top: 5px solid #ffcc00;
      border-radius: 50%;
      animation: spin 1.5s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    #ar-container {
      position: relative;
      width: 100%;
      height: 100%;
      display: none; /* Initially hidden */
    }
    
    #ar-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    
    #controls {
      position: absolute;
      bottom: 30px;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 15px;
      z-index: 10;
      padding: 0 15px;
    }
    
    .discipline-btn {
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50px;
      color: white;
      padding: 14px 25px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      flex: 1;
      max-width: 200px;
      justify-content: center;
    }
    
    .discipline-btn:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
    }
    
    .discipline-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    #design-btn {
      background: rgba(59, 130, 246, 0.8);
      border-color: rgba(147, 197, 253, 0.5);
    }
    
    #history-btn {
      background: rgba(34, 197, 94, 0.8);
      border-color: rgba(134, 239, 172, 0.5);
    }
    
    #business-btn {
      background: rgba(245, 158, 11, 0.8);
      border-color: rgba(253, 230, 138, 0.5);
    }
    
    #info-panel {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      padding: 15px 25px;
      border-radius: 15px;
      max-width: 90%;
      text-align: center;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      z-index: 10;
      display: none;
      width: 90%;
      max-width: 600px;
    }
    
    #info-text {
      font-size: 1.1rem;
      line-height: 1.6;
    }
    
    .icon {
      width: 24px;
      height: 24px;
      filter: drop-shadow(0 0 2px rgba(0,0,0,0.5));
    }
    
    .pattern-container {
      position: absolute;
      bottom: 120px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 10px;
      border-radius: 10px;
      z-index: 10;
      text-align: center;
      display: none;
    }
    
    .pattern-container img {
      width: 150px;
      height: 150px;
      border: 1px solid #ccc;
    }
    
    .pattern-container p {
      color: #333;
      font-weight: bold;
      margin-top: 8px;
    }
    
    #tracking-status {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.9rem;
      z-index: 10;
      backdrop-filter: blur(10px);
    }
    
    #instructions {
      position: absolute;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      padding: 12px 20px;
      border-radius: 12px;
      text-align: center;
      backdrop-filter: blur(10px);
      z-index: 10;
      max-width: 90%;
    }
    
    #error-panel {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(200, 0, 0, 0.85);
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      z-index: 110;
      display: none;
      max-width: 90%;
      width: 400px;
    }
    
    #error-message {
      margin: 15px 0;
      line-height: 1.6;
    }
    
    #retry-btn {
      background: #fff;
      color: #b21f1f;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 15px;
    }
    
    @media (max-width: 768px) {
      #controls {
        flex-wrap: wrap;
        bottom: 15px;
      }
      
      .discipline-btn {
        padding: 12px 15px;
        font-size: 1rem;
        flex-basis: calc(33% - 10px);
        max-width: none;
      }
      
      #info-panel {
        top: 10px;
        padding: 12px 15px;
      }
      
      #instructions {
        bottom: 150px;
        width: 95%;
      }
    }
  </style>
</head>
<body>
  <div id="loading">
    <h1>Cultural AR Experience</h1>
    <p>Loading immersive technology...</p>
    <div class="loader"></div>
    <p id="progress">Initializing AR engine - 0%</p>
  </div>
  
  <div id="error-panel">
    <h2>AR Initialization Error</h2>
    <p id="error-message"></p>
    <button id="retry-btn">Retry</button>
  </div>
  
  <div id="ar-container">
    <canvas id="ar-canvas"></canvas>
    
    <div id="info-panel">
      <div id="info-text"></div>
    </div>
    
    <div id="tracking-status">Target not detected</div>
    
    <div id="instructions">
      Point your camera at the Greek pattern to see the artifact
    </div>
    
    <div class="pattern-container">
      <p>Scan this pattern</p>
      <img id="pattern-img" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiB2aWV3Qm94PSIwIDAgMjAwIDIwMCI+PHJlY3Qgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9IiNmZmYiLz48cGF0aCBkPSJNMCA1MEgyMDBWMEgweiIgZmlsbD0iIzMzMyIvPjxwYXRoIGQ9Ik0wIDEwMEgyMDBWNTBIMHoiIGZpbGw9IiNmZmYiLz48cGF0aCBkPSJNMCAxNTBIMjAwVjEwMEgweiIgZmlsbD0iIzMzMyIvPjxwYXRoIGQ9Ik0wIDIwMEgyMDBWMTUwSDB6IiBmaWxsPSIjZmZmIi8+PHBhdGggZD0iTTUwIDBIMFYyMDBINTBWMHoiIGZpbGw9IiMzMzMiLz48cGF0aCBkPSJNMTAwIDBINDBWMjAwSDEwMFYweiIgZmlsbD0iI2ZmZiIvPjxwYXRoIGQ9Ik0xNTAgMEgxMDBWMjAwSDE1MFYweiIgZmlsbD0iIzMzMyIvPjxwYXRoIGQ9Ik0yMDAgMEgxNTBWMjAwSDIwMFYweiIgZmlsbD0iI2ZmZiIvPjwvc3ZnPg==" alt="Greek Pattern">
    </div>
    
    <div id="controls">
      <button id="design-btn" class="discipline-btn" disabled>
        <svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M20.71,7.04c.39-.39.39-1.02,0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41,0l-1.84,1.83l3.75,3.75l1.84-1.83z M3.53,19.94l2.34,2.34c.39.39,1.02.39,1.41,0l7.07-7.07L9,9L0,18L3.53,19.94z"/></svg>
        Design
      </button>
      <button id="history-btn" class="discipline-btn" disabled>
        <svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M11.9,3H4v2h7.9V13.8c0,2.49,2.01,4.5,4.5,4.5s4.5-2.01,4.5-4.5s-2.01-4.5-4.5-4.5c-1.86,0-3.49,1.09-4.24,2.67h-2.1 c1.02-2.01,2.87-3.44,5.34-3.44c3.31,0,6,2.69,6,6s-2.69,6-6,6s-6-2.69-6-6V3z"/></svg>
        History
      </button>
      <button id="business-btn" class="discipline-btn" disabled>
        <svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M20,4H4C2.9,4,2.01,4.9,2.01,6L2,18c0,1.1,0.9,2,2,2h16c1.1,0,2-0.9,2-2V6C22,4.9,21.1,4,20,4z M10,8h4v10h-4V8z M8,8v10H4V8H8z M20,18h-4V8h4V18z"/></svg>
        Business
      </button>
    </div>
  </div>

  <script>
    // Initialize variables
    let mindarThree = null;
    let model = null;
    let anchorGroup = null;
    
    // Update progress display
    function updateProgress(message, percent) {
      document.getElementById('progress').textContent = `${message}... ${percent}%`;
    }
    
    // Show message function
    function showMessage(text, duration = 3000) {
      const infoPanel = document.getElementById('info-panel');
      const infoText = document.getElementById('info-text');
      
      infoText.innerHTML = text.replace(/\n/g, '<br>');
      infoPanel.style.display = 'block';
      
      if (duration > 0) {
        setTimeout(() => {
          infoPanel.style.display = 'none';
        }, duration);
      }
    }
    
    // Show error message
    function showError(message) {
      const errorPanel = document.getElementById('error-panel');
      const errorMessage = document.getElementById('error-message');
      
      errorMessage.textContent = message;
      errorPanel.style.display = 'block';
      document.getElementById('loading').style.display = 'none';
      
      console.error("AR Error: ", message);
    }
    
    // Enable buttons
    function enableButtons() {
      document.getElementById('design-btn').disabled = false;
      document.getElementById('history-btn').disabled = false;
      document.getElementById('business-btn').disabled = false;
    }
    
    // Initialize AR experience
    async function initAR() {
      try {
        updateProgress('Starting AR engine', 20);
        
        // Create MindAR instance
        mindarThree = new window.MINDAR.IMAGE.MindARThree({
          container: document.getElementById('ar-container'),
          imageTargetSrc: './assets/target.mind',
          maxTrack: 1,
          filterMinCF: 0.001,
          filterBeta: 0.1,
          uiScanning: 'no',
          uiLoading: 'no'
        });
        
        const { renderer, scene, camera } = mindarThree;
        
        // Set up renderer
        const canvas = document.getElementById('ar-canvas');
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0x000000, 0);
        
        // Add lighting
        updateProgress('Setting up lighting', 40);
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(10, 10, 10);
        scene.add(directionalLight);
        
        // Create a placeholder model (box)
        updateProgress('Creating 3D model', 60);
        const geometry = new THREE.BoxGeometry(1, 1, 1);
        const material = new THREE.MeshPhongMaterial({ 
          color: 0x3498db,
          shininess: 100,
          specular: 0xffffff
        });
        
        model = new THREE.Mesh(geometry, material);
        model.scale.set(0.3, 0.3, 0.3);
        model.visible = false;
        
        // Create anchor group for the target
        anchorGroup = mindarThree.addAnchor(0);
        anchorGroup.group.add(model);
        
        // Add button event listeners
        document.getElementById('design-btn').addEventListener('click', changeDesign);
        document.getElementById('history-btn').addEventListener('click', showHistory);
        document.getElementById('business-btn').addEventListener('click', showBusiness);
        
        // Start AR
        updateProgress('Initializing camera', 80);
        await mindarThree.start();
        
        // Show AR container
        document.getElementById('ar-container').style.display = 'block';
        
        // Hide loading screen
        document.getElementById('loading').style.display = 'none';
        
        // Show pattern container
        document.querySelector('.pattern-container').style.display = 'block';
        
        // Enable buttons
        enableButtons();
        
        // Show initial message
        showMessage("Point your camera at the Greek pattern to see the artifact", 5000);
        
        // Render loop
        renderer.setAnimationLoop(() => {
          // Update tracking status
          const trackingStatus = document.getElementById('tracking-status');
          
          // SAFE CHECK: Ensure anchorGroup exists
          if (anchorGroup && anchorGroup.group.visible) {
            trackingStatus.textContent = "Target detected";
            trackingStatus.style.background = "rgba(34, 197, 94, 0.8)";
          } else {
            trackingStatus.textContent = "Target not detected";
            trackingStatus.style.background = "rgba(220, 38, 38, 0.8)";
          }
          
          // Update model rotation when visible
          if (model && model.visible) {
            model.rotation.y += 0.01;
          }
          
          renderer.render(scene, camera);
        });
        
      } catch (error) {
        console.error("AR initialization failed:", error);
        showError(`AR initialization failed: ${error.message || 'Unknown error'}`);
      }
    }
    
    // Button functions
    function changeDesign() {
      if (!model) return;
      
      model.scale.multiplyScalar(1.2);
      showMessage("Design: Enhanced visual prominence<br>Scale increased by 20%<br>Current scale: " + model.scale.x.toFixed(1) + "x");
    }
    
    function showHistory() {
      const historyText = "Ancient Greek Amphora<br><br>Period: 5th Century BCE<br>Purpose: Ceremonial vessel for storing wine and oil<br>Cultural Significance: Symbol of trade between Athens and other city-states. Often given as prizes in athletic competitions.";
      showMessage(historyText, 5000);
    }
    
    function showBusiness() {
      const businessText = "Business Models:<br><br>- Free: Basic content access<br>- Premium: $4.99/month (includes expert commentary)<br>- Educational License: $299/year<br>- Sponsored Content Partnerships";
      showMessage(businessText, 6000);
    }
    
    // Handle window resize
    window.addEventListener('resize', () => {
      if (mindarThree) {
        const { renderer } = mindarThree;
        renderer.setSize(window.innerWidth, window.innerHeight);
      }
    });
    
    // Retry button
    document.getElementById('retry-btn').addEventListener('click', () => {
      document.getElementById('error-panel').style.display = 'none';
      document.getElementById('loading').style.display = 'flex';
      initAR();
    });
    
    // Start AR application
    initAR();
  </script>
</body>
</html>
